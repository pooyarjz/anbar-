{% load static %}
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>گزارش‌ها و نمودارها</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4">گزارش‌ها و نمودارها</h1>
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">از تاریخ</label>
      <input id="from" type="date" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label">تا تاریخ</label>
      <input id="to" type="date" class="form-control">
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button id="reload" class="btn btn-primary w-100">به‌روزرسانی</button>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">مصرف بر اساس کد (Top 20)</div>
    <div class="card-body">
      <canvas id="chartCode"></canvas>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">ورود/خروج روزانه</div>
    <div class="card-body">
      <canvas id="chartMove"></canvas>
    </div>
  </div>
</div>

<script>
async function fetchJSON(url){
  const r = await fetch(url, {credentials:'include'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
function qs(p){ return new URLSearchParams(p).toString(); }

let chartCode, chartMove;
async function loadCharts(){
  const from = document.getElementById('from').value;
  const to = document.getElementById('to').value;
  const cons = await fetchJSON('/api/reports/consumption/?'+qs({group_by:'code'}));
  const top = cons.slice(0, 20);
  const labels1 = top.map(x=>x.code);
  const data1 = top.map(x=>x.amount);
  if(chartCode) chartCode.destroy();
  chartCode = new Chart(document.getElementById('chartCode'), {
    type: 'bar',
    data: { labels: labels1, datasets: [{ label: 'مصرف', data: data1 }] },
    options: { responsive:true, scales:{ x:{ticks:{autoSkip:false}} } }
  });

  const move = await fetchJSON('/api/reports/movement/?'+qs({from, to}));
  const labels2 = move.map(x=>x.date);
  const dataIn = move.map(x=>x.in);
  const dataOut = move.map(x=>x.out);
  const dataNet = move.map(x=>x.net);
  if(chartMove) chartMove.destroy();
  chartMove = new Chart(document.getElementById('chartMove'), {
    type:'line',
    data:{ labels: labels2, datasets: [
      { label:'ورود', data:dataIn },
      { label:'خروج', data:dataOut },
      { label:'خالص', data:dataNet }
    ]},
    options:{ responsive:true }
  });
}
document.getElementById('reload').addEventListener('click', loadCharts);
window.addEventListener('load', loadCharts);
</script>
</body>
</html>
